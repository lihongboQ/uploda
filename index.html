<!DOCTYPE html>
<html>

<head>
  <title>æ–‡ä»¶ä¸Šä¼ ç¤ºä¾‹</title>
</head>

<body>
  <!-- æ–‡ä»¶é€‰æ‹©è¡¨å• -->
  <input type="file" id="fileInput" multiple>
  <button onclick="upload()">ä¸Šä¼ æ–‡ä»¶</button>

  <!-- è¿›åº¦æ˜¾ç¤º -->
  <div id="progress" style="width: 300px; height: 20px; background: #eee; margin-top: 10px;">
    <div id="progressBar" style="width: 0%; height: 100%; background: #4CAF50;"></div>
  </div>
  <p id="status"></p>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
  <script>
    const CHUNK_SIZE = 2 * 1024 * 1024; // åˆ†ç‰‡å¤§å°2MB

    async function upload() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) return alert('è¯·é€‰æ‹©æ–‡ä»¶');

      // è®¡ç®—æ–‡ä»¶å”¯ä¸€hashï¼ˆç”¨äºæ–­ç‚¹ç»­ä¼ ï¼‰
      const fileHash = await calculateFileHash(file);

      // è·å–å·²ä¸Šä¼ åˆ†ç‰‡ï¼ˆå®ç°æ–­ç‚¹ç»­ä¼ ï¼‰
      const { data: existChunks } = await axios.get('http://localhost:3000/api/check', {
        params: { hash: fileHash }
      });

      // åˆ›å»ºåˆ†ç‰‡æ•°ç»„
      const chunks = createFileChunks(file, CHUNK_SIZE);
      const requests = chunks.map((chunk, index) => {
        // è·³è¿‡å·²ä¸Šä¼ åˆ†ç‰‡
        console.log("ğŸš€ ~ requests ~ existChunks:", existChunks)
        if (existChunks.data.includes(index.toString())) return null;

        const formData = new FormData();
        formData.append('file', chunk.file);
        formData.append('hash', fileHash);
        formData.append('index', index);
        formData.append('total', chunks.length);

        return axios.post('http://localhost:3000/api/upload', formData, {
          onUploadProgress: createProgressHandler(index, chunks.length)
        });
      }).filter(Boolean);
        

      // å¹¶è¡Œä¸Šä¼ ï¼ˆå¯æ§åˆ¶å¹¶å‘æ•°ï¼‰
      await Promise.all(requests);

      // é€šçŸ¥åˆå¹¶æ–‡ä»¶
      await axios.post('/api/merge', {
        hash: fileHash,
        filename: file.name,
        total: chunks.length
      });

      alert('ä¸Šä¼ å®Œæˆ');
    }

    // åˆ›å»ºæ–‡ä»¶åˆ†ç‰‡
    function createFileChunks(file, chunkSize) {
      const chunks = [];
      let cur = 0;
      while (cur < file.size) {
        chunks.push({
          file: file.slice(cur, cur + chunkSize),
          index: chunks.length
        });
        cur += chunkSize;
      }
      return chunks;
    }

    // è®¡ç®—æ–‡ä»¶hash
    function calculateFileHash(file) {
      return new Promise(resolve => {
        const spark = new SparkMD5.ArrayBuffer();
        const reader = new FileReader();
        const chunkSize = 2 * 1024 * 1024;
        let cur = 0;

        reader.onload = e => {
          spark.append(e.target.result);
          cur += chunkSize;
          if (cur >= file.size) {
            resolve(spark.end());
            return;
          }
          loadNext();
        };

        function loadNext() {
          const chunk = file.slice(cur, cur + chunkSize);
          reader.readAsArrayBuffer(chunk);
        }

        loadNext();
      });
    }

    // è¿›åº¦å¤„ç†å‡½æ•°
    function createProgressHandler(index, total) {
      const progressBar = document.getElementById('progress');
      return progress => {
        const percent = Math.round((progress.loaded / progress.total) * 100);
        progressBar.innerHTML = `åˆ†ç‰‡ ${index + 1}/${total}ï¼š${percent}%<br>`;
      };
    }
  </script>
</body>

</html>